
<link rel="import" href="../bower_components/polymer/polymer.html">
<link rel="import" href="../bower_components/paper-card/paper-card.html">
<link rel="import" href="../bower_components/paper-button/paper-button.html">
<link rel="import" href="../bower_components/paper-input/paper-input.html">
<link rel="import" href="../bower_components/iron-form/iron-form.html">
<link rel="import" href="../bower_components/iron-icons/iron-icons.html">
<link rel="import" href="../bower_components/paper-icon-button/paper-icon-button.html">
<link rel="import" href="../bower_components/iron-ajax/iron-ajax.html">
<link rel="import" href="../bower_components/paper-radio-group/paper-radio-group.html">
<link rel="import" href="../bower_components/paper-dialog/paper-dialog.html">
<link rel="import" href="../bower_components/neon-animation/neon-animations.html">

<dom-module id="day-week">
  <template>
    <style>
      :host {
        display: block;
        padding: 10px;
      }
      .active {
        background-color: #91e6b8;
      }
      paper-card {
      --paper-card-header-text: {
          font-weight: bold;
          color: #fff;
          text-shadow: 3px 2px 1px #000;
        }
      }
      paper-card.active {
      --paper-card-header-text: {
          color: #91e6b8;
          font-weight: bold;
          text-shadow: 3px 2px 1px #000;
        }
      }
      paper-radio-button {
        display: block;
      }
      #optionDialog {
        max-width: 300px !important;
      }
    </style>

    <iron-ajax
       id="orderAjax"
       url="/api/order/create"
       method="POST"
       content-type="application/json"
       handle-as="json"
       on-response="_onOrderResponse"
       on-error="_errorResponse">
      </iron-ajax>


    <paper-dialog id="optionDialog" entry-animation="scale-up-animation" exit-animation="fade-out-animation" with-backdrop>
      <h2>Первое на выбор</h2>
      <paper-radio-group selected="{{meal.custom}}">
        <paper-radio-button cheked name="default">Default</paper-radio-button>
        <paper-radio-button name="meat">Мясо</paper-radio-button>
        <paper-radio-button name="cheese">Творог</paper-radio-button>
      </paper-radio-group>
    </paper-dialog>
    <paper-card class$="{{_isActive(meal.active)}}" heading="{{meal.name}}/{{meal.day}}" image="http://www.mumbaifoodie.com/wp-content/uploads/2016/07/International-Food-Trends-350x150.jpg" alt="Emmental">
      <form is="iron-form">
        <div class="card-content">
          <paper-input disabled$="{{meal.disabled}}" type='number' name='full' value='{{meal.full}}' label="Полное"></paper-input>
          <paper-input disabled$="{{meal.disabled}}" type='number' name='first' value='{{meal.first}}' label="Первое"></paper-input>
          <paper-input disabled$="{{meal.disabled}}" type='number' name='second' value='{{meal.second}}' label="Второе"></paper-input>
          <div>{{_calc(meal.full,meal.first,meal.second)}} MDL</div>
        </div>
        <div class="card-actions">
          <paper-icon-button disabled$="{{meal.disabled}}" on-click="_makeOrder" icon="save"></paper-icon-button>
          <template is="dom-if" if="{{meal.custom}}">
            <paper-icon-button on-click='_openOptionDialog' icon="build"></paper-icon-button>
          </template>
        </div>
      </form>
    </paper-card>

  </template>
  <script>
    Polymer({

      is: 'day-week',
      properties: {
        meal: {
          type: Object,
          notify: true
        },
        amount: {
          type: Number,
          value: 0,
          notify: true
        }
      },

      _makeOrder: function(ev) {
        var order = ev.currentTarget.parentElement.parentElement.serialize();
        var isValid = false
        for(var key in order) {
          if (order[key] && Number(order[key]) > 0) {
            isValid = true
          } else {
            delete order[key]
          }
        }
        if(isValid) {
          order.dayid = this.meal.dayid;
          order.custom = this.meal.custom;
          this.$.orderAjax.body = order;
          this.$.orderAjax.generateRequest();
        } else {
          this.fire('iron-signal', {name:'toast', data: {type: 'error', message: 'Fill order'}});
        }
      },

      _isActive: function() {
        if (this.meal == undefined) {return ''}
        return this.meal.active ? 'active' : '';
      },

      _calc: function(full, first, second) {
        var price = this.meal.price;
        var amount =
          Number(full) * Number(price.full) +
          Number(first) * Number(price.first) +
          Number(second) * Number(price.second);
        this.set('amount', amount);
        return amount
      },

      _openOptionDialog: function() {
        this.$.optionDialog.open();
      },

      _onOrderResponse: function() {
        this.fire('iron-signal', {name:'toast', data: {type: 'success', message: 'Order saved successfully'}});
        this.fire('iron-signal', {name: 'update-week'});
      },

      _errorResponse:function(ev, data) {
        this.fire('iron-signal', {name:'toast', data: {type: 'error', message: data.request.response.error}});
      }

    });
  </script>
</dom-module>
