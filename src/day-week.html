
<link rel="import" href="../bower_components/polymer/polymer.html">
<link rel="import" href="../bower_components/paper-card/paper-card.html">
<link rel="import" href="../bower_components/paper-button/paper-button.html">
<link rel="import" href="../bower_components/paper-input/paper-input.html">
<link rel="import" href="../bower_components/iron-form/iron-form.html">
<link rel="import" href="../bower_components/iron-icons/iron-icons.html">
<link rel="import" href="../bower_components/paper-icon-button/paper-icon-button.html">
<link rel="import" href="../bower_components/iron-ajax/iron-ajax.html">

<dom-module id="day-week">
  <template>
    <style>
      :host {
        display: block;
        padding: 10px;
      }
      .active {
        background-color: #91e6b8;
      }
    </style>

    <iron-ajax
       id="orderAjax"
       url="/api/order/create"
       method="POST"
       content-type="application/json"
       handle-as="json"
       on-response="_onOrderResponse"
       on-error="_errorResponse">
      </iron-ajax>

    <paper-card class$="{{_isActive(meal.active)}}" heading="{{meal.name}}/{{meal.day}}" image="http://placehold.it/350x150/FFC107/000000" alt="Emmental">
      <form is="iron-form">
        <div class="card-content">
          <paper-input disabled$="{{meal.disabled}}" type='number' name='full' value='{{meal.full}}' label="Полное"></paper-input>
          <paper-input disabled$="{{meal.disabled}}" type='number' name='first' value='{{meal.first}}' label="Первое"></paper-input>
          <paper-input disabled$="{{meal.disabled}}" type='number' name='second' value='{{meal.second}}' label="Второе"></paper-input>
          <div>{{_calc(meal.full,meal.first,meal.second)}} MDL</div>
        </div>
        <div class="card-actions">
          <paper-icon-button disabled$="{{meal.disabled}}" on-click="_makeOrder" icon="save"></paper-icon-button>
          <!--<paper-icon-button icon="subject"></paper-icon-button>-->
        </div>
      </form>
    </paper-card>

  </template>
  <script>
    Polymer({

      is: 'day-week',
      properties: {
        meal: {
          type: Object,
          notify: true
        },
        amount: {
          type: Number,
          value: 0,
          notify: true
        }
      },

      _makeOrder: function(ev) {
        var order = ev.currentTarget.parentElement.parentElement.serialize();
        var isValid = false
        for(var key in order) {
          if (order[key] && Number(order[key]) > 0) {
            isValid = true
          } else {
            delete order[key]
          }
        }
        if(isValid) {
          order.dayid = this.meal.dayid;
          this.$.orderAjax.body = order;
          this.$.orderAjax.generateRequest();
        } else {
          this.fire('iron-signal', {name:'toast', data: {type: 'error', message: 'Fill order'}});
        }
      },

      _isActive: function() {
        if (this.meal == undefined) {return ''}
        return this.meal.active ? 'active' : '';
      },

      _calc: function(full, first, second) {
        var price = this.meal.price;
        var amount =
          Number(full) * Number(price.full) +
          Number(first) * Number(price.first) +
          Number(second) * Number(price.second);
        this.set('amount', amount);
        return amount
      },

      _onOrderResponse: function() {
        this.fire('iron-signal', {name:'toast', data: {type: 'success', message: 'Order saved successfully'}});
        this.fire('iron-signal', {name: 'update-week'});
      },

      _errorResponse:function(ev, data) {
        this.fire('iron-signal', {name:'toast', data: {type: 'error', message: data.request.response.error}});
      }

    });
  </script>
</dom-module>
