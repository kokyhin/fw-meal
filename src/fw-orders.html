
<link rel="import" href="../bower_components/polymer/polymer.html">
<link rel="import" href="../bower_components/iron-data-table/iron-data-table.html">
<link rel="import" href="../bower_components/paper-tabs/paper-tabs.html">
<link rel="import" href="../bower_components/paper-tabs/paper-tab.html">
<link rel="import" href="../bower_components/iron-pages/iron-pages.html">
<link rel="import" href="../bower_components/iron-flex-layout/iron-flex-layout-classes.html">
<link rel="import" href="../bower_components/paper-checkbox/paper-checkbox.html">

<dom-module id="fw-orders">
  <template>
    <style include='iron-flex'></style>
    <style>
      :host {
        display: block;
        padding: 10px;
      }
      paper-tabs {
        --paper-tabs-container: {
          background-color: #325B9E;
          color: #fff;
        }
      }
      .total {
        background-color: #c4da1b !important;
      }
    </style>

    <iron-ajax id="getOrders"
      auto
      method="GET"
      url="/api/order/get-orders"
      handle-as="json"
      content-type="application/json"
      on-error="_errorResponse"
      on-response='_onGetOrders'
      last-response="{{data}}"
    ></iron-ajax>

    <iron-ajax id="getDayOrders"
      method="POST"
      url="/api/order/get-orders-day"
      handle-as="json"
      content-type="application/json"
      on-error="_errorResponse"
      on-response="_onGetDayOrders"
    ></iron-ajax>

    <iron-ajax id="updateOrder"
      method="POST"
      url="/api/order/update-order"
      handle-as="json"
      content-type="application/json"
      on-error="_errorResponse"
    ></iron-ajax>
    <paper-tabs selected="{{activeDay}}" autoselect autoselect-delay="1000">
      <template is='dom-repeat' items='{{data.days}}'>
        <paper-tab on-click='_getDayTable'>{{item.name}}-{{item.day}}</paper-tab>
      </template>
    </paper-tabs>

    <iron-data-table id='orderTable' items="[[dayTable]]">
      <data-table-column name="User" filter-by="user.username">
        <template>[[item.user.username]]</template>
      </data-table-column>
      <data-table-column name="Полное">
        <template>[[item.full]]</template>
      </data-table-column>
      <data-table-column name="Первое">
        <template>[[item.first]]</template>
      </data-table-column>
      <data-table-column name="Второе">
        <template>[[item.second]]</template>
      </data-table-column>
      <data-table-column name="Сумма">
        <template>[[item.total]]</template>
      </data-table-column>
      <data-table-column name="Options">
        <template>[[item.custom]]</template>
      </data-table-column>
      <data-table-column name="Оплачено">
        <template>
          <paper-checkbox on-change="_updateOrder" checked={{item.payed}}></paper-checkbox>
        </template>
      </data-table-column>
    </iron-data-table>

  </template>
  <script>
    Polymer({

      is: 'fw-orders',

      properties: {
        dayTable : Array,
        activeDay: ''
      },

      _getDayTable: function(ev) {
        this.$.getDayOrders.body = {day: ev.model.item.dayid};
        this.$.getDayOrders.generateRequest();
        window.overlay.show();
      },

      _updateOrder: function(ev){
        this.$.updateOrder.body = {
          id: ev.model.item._id,
          payed: ev.model.item.payed
        };
        this.$.updateOrder.generateRequest();
      },

      _onGetDayOrders: function(ev, data) {
        this.set('dayTable', data.response);
        window.overlay.hide();
        this.$.orderTable.querySelectorAll('data-table-row').forEach(function(element) {
          element.classList -= ' total'
        }, this);
        var index = data.response.length;
        this.$.orderTable.querySelectorAll('data-table-row')[index].classList += ' total'
      },

      _onGetOrders: function(ev, data) {
        this.set('activeDay', data.response.active)
        this.$.getDayOrders.body = {day: data.response.days[data.response.active].dayid};
        this.$.getDayOrders.generateRequest();
        window.overlay.show();
      },

      _errorResponse: function(ev, res) {
        this.fire('iron-signal', {name:'toast', data: {type: 'error', message: res.request.response.error}});
        window.overlay.hide()
      }

    });
  </script>
</dom-module>
