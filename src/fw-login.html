<link rel="import" href="../bower_components/polymer/polymer.html">
<link rel="import" href="../bower_components/iron-flex-layout/iron-flex-layout-classes.html">
<link rel="import" href="../bower_components/iron-ajax/iron-ajax.html">
<link rel="import" href="../bower_components/iron-form/iron-form.html">
<link rel="import" href="../bower_components/paper-input/paper-input.html">
<link rel="import" href="../bower_components/paper-button/paper-button.html">
<link rel="import" href="../bower_components/paper-tabs/paper-tabs.html">
<link rel="import" href="../bower_components/iron-pages/iron-pages.html">
<link rel="import" href="../bower_components/gold-email-input/gold-email-input.html">
<link rel="import" href="../bower_components/paper-password-input/paper-password-input.html">
<link rel="import" href="../bower_components/paper-password-input/match-passwords-validator.html">
<link rel="import" href="../bower_components/paper-password-input/min-length-validator.html">
<link rel="import" href="../bower_components/iron-signals/iron-signals.html">

<dom-module id="fw-login">
  <template>
    <style include='iron-flex'></style>
    <style>
      :host {
        -ms-flex-direction: column;
        -webkit-flex-direction: column;
        flex-direction: column;
        display: -ms-flexbox;
        display: -webkit-flex;
        display: flex;
        min-height: -moz-calc(100vh - 79px);
        min-height: -webkit-calc(100vh - 79px);
        min-height: calc(100vh - 79px);
      }
      .form-wrapper {
        min-width: 300px;
      }
      paper-tabs {
        --paper-tabs-container: {
          background-color: #325B9E;
          color: #fff;
        }
      }
      paper-tabs a {
        color: #fff;
        text-decoration: none;
      }

    </style>
    <iron-ajax id="regUser"
      method="POST"
      url="/api/auth/register"
      handle-as="json"
      content-type="application/json"
      on-response="_onRegisterResponse"
      on-error="_errorResponse"
    ></iron-ajax>

    <div class="flex layout horizontal center-center">
      <div class="form-wrapper">

        <paper-tabs selected="{{activeTab}}">
          <paper-tab>Sign In</paper-tab>
          <paper-tab>Sign Up</paper-tab>
        </paper-tabs>

        <iron-pages selected="{{activeTab}}">
          <div>
            <form is="iron-form" id="loginForm">
              <paper-input name="name" label="Name" minlength="4" required error-message="Required at least 4 digits"></paper-input>
              <min-length-validator id="min-length-validator" min-length="4"></min-length-validator>
              <paper-password-input auto-validate label="Password" id='loginPassword' validator="min-length-validator" error-message="Enter at least 4 characters"></paper-password-input>
              <paper-button on-click='_submitLoginForm' raised>Submit</paper-button>
            </form>
          </div>

          <div>
            <form is="iron-form" id="registerForm">
              <paper-input name="name" label="Name" minlength="4" required error-message="Required at least 4 digits"></paper-input>
              <match-passwords-validator id="match-passwords-validator" password="[[password]]"></match-passwords-validator>
              <paper-password-input name="password" label="Password" value="{{password}}"></paper-password-input>
              <paper-password-input label="Confirm" id='RegPass' auto-validate validator="match-passwords-validator" error-message="Passwords need to match"></paper-password-input>
              <gold-email-input name="email" label="E-mail" required error-message="Invalid Email"></gold-email-input>
              <paper-button on-click='_submitRegisterForm' raised>Submit</paper-button>
            </form>
          </div>
        </iron-pages>

      </div>
    </div>

  </template>
  <script>
    Polymer({
      is: 'fw-login',

      properties: {
        activeTab: {
          type: String,
          value: '0'
        }
      },

      _submitRegisterForm: function() {
        var that = this;
        var checkLoginPassword = function(pass) {
          if (!pass.length) {
            that.fire('iron-signal', {name:'toast', data: {type: 'error', message: 'Password required'}});
            return false
          }
          return true
        }
        if(this.$.registerForm.validate() && checkLoginPassword(this.$.RegPass.value)) {
          var body = this.$.registerForm.serialize();
          body.password = this.password;
          this.$.regUser.body = body;
          this.$.regUser.generateRequest();
        }
      },

      _submitLoginForm:function() {
        var that = this;
        var checkLoginPassword = function(pass) {
          if (!pass.length) {
            that.fire('iron-signal', {name:'toast', data: {type: 'error', message: 'Password required'}});
            return false
          }
          return true
        }
        if(this.$.loginForm.validate() && checkLoginPassword(this.$.loginPassword.value)) {
          console.log('Entered')
          var body = this.$.loginForm.serialize();
          body.password = this.$.loginPassword.value;
        }
      },

      _errorResponse: function(ev, res) {
        this.fire('iron-signal', {name:'toast', data: {type: 'error', message: res.request.response.error}});
      },

      _onRegister: function() {
        this.fire('iron-signal', {name:'toast', data: {type: 'success', message: 'You have successfully registered.  Please Login.'}});
      }

    });
  </script>
</dom-module>
